<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Sudoku</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .debug-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }

        .debug-section h3 {
            margin-top: 0;
            color: #007bff;
        }

        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }

        .result {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .test-game {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
        }

        .test-game h3 {
            color: #17a2b8;
            margin-top: 0;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Sudoku</h1>

    <div class="debug-section">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoints</h3>
        <button onclick="testNewGame()">–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã</button>
        <button onclick="testGetStats()">–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
        <button onclick="testSaveStats()">–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
        <div id="apiResults" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ</h3>
        <button onclick="checkDatabase()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
        <div id="dbResults" class="result"></div>
    </div>

    <div class="test-game">
        <h3>3. –°–∏–º—É–ª—è—Ü–∏—è –ø–æ–ª–Ω–æ–π –∏–≥—Ä—ã</h3>
        <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É, "—Ä–µ—à–∏—Ç" –µ—ë –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</p>
        <button onclick="simulateFullGame()">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –∏–≥—Ä—É</button>
        <div id="gameResults" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>4. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞</h3>
        <p>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ JavaScript</p>
        <button onclick="logDebugInfo()">–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
    </div>
</div>

<script>
    async function testNewGame() {
        const resultDiv = document.getElementById('apiResults');
        resultDiv.innerHTML = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã...';

        try {
            const response = await fetch('/api/new?level=EASY');
            const data = await response.json();

            if (response.ok) {
                resultDiv.innerHTML = `‚úÖ –ù–æ–≤–∞—è –∏–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ:
ID: ${data.id}
Seed –¥–ª–∏–Ω–∞: ${data.seed.length}
–£—Ä–æ–≤–µ–Ω—å: ${data.level}`;
                resultDiv.className = 'result success';

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Ç–µ—Å—Ç–æ–≤
                window.testGameData = data;
            } else {
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } catch (error) {
            resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã: ${error.message}`;
            resultDiv.className = 'result error';
        }
    }

    async function testGetStats() {
        const resultDiv = document.getElementById('apiResults');
        resultDiv.innerHTML = '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...';

        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            if (response.ok) {
                const statsInfo = `‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞:
–í—Å–µ–≥–æ –∏–≥—Ä: ${data.totalStats.totalGames}
–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: ${formatTime(Math.floor(data.totalStats.avgTime))}
–õ—É—á—à–µ–µ –≤—Ä–µ–º—è: ${formatTime(data.totalStats.bestTime)}
–ò—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä: ${data.gameHistory.length}

${data.gameHistory.length > 0 ?
                    '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã:\n' + data.gameHistory.slice(0, 5).map((game, i) =>
                        `  ${i+1}. ${game.level} - ${game.formattedDuration}`).join('\n')
                    : '–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä –ø—É—Å—Ç–∞'}`;

                resultDiv.innerHTML = statsInfo;
                resultDiv.className = 'result success';
            } else {
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } catch (error) {
            resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}`;
            resultDiv.className = 'result error';
        }
    }

    async function testSaveStats() {
        const resultDiv = document.getElementById('apiResults');

        if (!window.testGameData) {
            resultDiv.innerHTML = '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∏–≥—Ä—É';
            resultDiv.className = 'result warning';
            return;
        }

        resultDiv.innerHTML = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...';

        try {
            const testStats = {
                puzzleId: window.testGameData.id.toString(),
                duration: 180 // 3 –º–∏–Ω—É—Ç—ã
            };

            const response = await fetch('/api/stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testStats)
            });

            const data = await response.json();

            if (response.ok) {
                resultDiv.innerHTML = `‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ:
Puzzle ID: ${testStats.puzzleId}
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${testStats.duration} —Å–µ–∫—É–Ω–¥
–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(data)}`;
                resultDiv.className = 'result success';
            } else {
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } catch (error) {
            resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}`;
            resultDiv.className = 'result error';
        }
    }

    async function checkDatabase() {
        const resultDiv = document.getElementById('dbResults');
        resultDiv.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API...';

        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            if (response.ok) {
                const dbInfo = `üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

–¢–∞–±–ª–∏—Ü–∞ stats:
- –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${data.totalStats.totalGames}
- –ï—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å–∏: ${data.totalStats.totalGames > 0 ? '–î–ê' : '–ù–ï–¢'}

–¢–∞–±–ª–∏—Ü–∞ puzzle:
- –ü–∞–∑–ª—ã —Å —É—Ä–æ–≤–Ω—è–º–∏: ${Object.keys(data.levelStats).join(', ') || '–ù–ï–¢'}

–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä:
- –ó–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏: ${data.gameHistory.length}
- –ü–æ—Å–ª–µ–¥–Ω—è—è –∏–≥—Ä–∞: ${data.gameHistory.length > 0 ?
                    `${data.gameHistory[0].level} - ${data.gameHistory[0].formattedDuration}` : '–ù–ï–¢'}`;

                resultDiv.innerHTML = dbInfo;
                resultDiv.className = data.totalStats.totalGames > 0 ? 'result success' : 'result warning';
            } else {
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } catch (error) {
            resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã: ${error.message}`;
            resultDiv.className = 'result error';
        }
    }

    async function simulateFullGame() {
        const resultDiv = document.getElementById('gameResults');
        resultDiv.innerHTML = 'üéÆ –°–∏–º—É–ª—è—Ü–∏—è –ø–æ–ª–Ω–æ–π –∏–≥—Ä—ã...';

        try {
            // 1. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É
            resultDiv.innerHTML += '\n1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã...';
            const newGameResponse = await fetch('/api/new?level=EASY');
            const gameData = await newGameResponse.json();

            if (!newGameResponse.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã: ' + gameData.error);
            }

            resultDiv.innerHTML += `\n   ‚úÖ –ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ (ID: ${gameData.id})`;

            // 2. –†–µ—à–∞–µ–º –∏–≥—Ä—É
            resultDiv.innerHTML += '\n2. –†–µ—à–µ–Ω–∏–µ –∏–≥—Ä—ã...';
            const solveResponse = await fetch('/api/solve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ seed: gameData.seed })
            });

            const solveData = await solveResponse.json();

            if (!solveResponse.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Ä–µ—à–µ–Ω–∏—è: ' + solveData.error);
            }

            resultDiv.innerHTML += '\n   ‚úÖ –ò–≥—Ä–∞ —Ä–µ—à–µ–Ω–∞';

            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            resultDiv.innerHTML += '\n3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...';
            const statsResponse = await fetch('/api/stats', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    puzzleId: gameData.id.toString(),
                    duration: Math.floor(Math.random() * 300) + 60 // 1-5 –º–∏–Ω—É—Ç
                })
            });

            const statsData = await statsResponse.json();

            if (!statsResponse.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + statsData.error);
            }

            resultDiv.innerHTML += '\n   ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞';

            // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            resultDiv.innerHTML += '\n4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è...';
            const checkResponse = await fetch('/api/stats');
            const checkData = await checkResponse.json();

            resultDiv.innerHTML += `\n   üìä –¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
   - –í—Å–µ–≥–æ –∏–≥—Ä: ${checkData.totalStats.totalGames}
   - –ò—Å—Ç–æ—Ä–∏–∏: ${checkData.gameHistory.length}`;

            resultDiv.className = 'result success';

        } catch (error) {
            resultDiv.innerHTML += `\n\n‚ùå –û–®–ò–ë–ö–ê: ${error.message}`;
            resultDiv.className = 'result error';
        }
    }

    function logDebugInfo() {
        console.log('=== –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø SUDOKU ===');
        console.log('User Agent:', navigator.userAgent);
        console.log('URL:', window.location.href);
        console.log('Local Storage –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof(Storage) !== "undefined");

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
        console.log('\n=== –ü–†–û–í–ï–†–ö–ê API ===');

        fetch('/api/stats')
            .then(response => {
                console.log('API Stats Status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API Stats Data:', data);
            })
            .catch(error => {
                console.error('API Stats Error:', error);
            });
    }

    function formatTime(seconds) {
        if (seconds === 0) return '0:00';
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        } else {
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
        setTimeout(() => {
            console.log('üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            console.log('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏');
        }, 1000);
    });
</script>
<script src="js/debug_stats.js"></script>
</body>
</html>